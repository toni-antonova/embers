shell: bash

commands:
  install:
    description: Install all dependencies including dev and ml extras
    cmd: uv sync --all-extras

  test:
    description: Run test suite
    cmd: uv run pytest tests/ -v

  test-cov:
    description: Run tests with coverage
    cmd: uv run pytest tests/ -v --cov=app --cov-report=term-missing

  format:
    description: Format code with ruff
    cmd: uv run ruff format app/ tests/

  lint:
    description: Lint code with ruff
    cmd: uv run ruff check app/ tests/

  lint-fix:
    description: Lint and auto-fix
    cmd: uv run ruff check --fix app/ tests/

  typecheck:
    description: Run mypy type checking
    cmd: uv run mypy app/

  validate:
    description: Run all checks (frontend + backend format + lint + typecheck + test)
    cmd: |
      echo "── Frontend ──"
      cd .. && npx eslint . --quiet && echo "  ✓ ESLint" && cd server
      cd .. && npx tsc --noEmit && echo "  ✓ TypeScript" && cd server
      echo "── Backend ──"
      uv run ruff format --check app/ tests/
      uv run ruff check app/ tests/
      uv run mypy app/
      uv run pytest tests/ -v

  preflight:
    description: Verify all ML imports resolve (no GPU needed) — run before build
    cmd: |
      UV_TORCH_BACKEND=cpu uv run python -c "
      # Core ML
      import torch; print(f'✓ torch {torch.__version__}')
      from diffusers import StableDiffusionXLPipeline; print('✓ StableDiffusionXLPipeline')
      import torch_cluster; print('✓ torch_cluster')

      # PartCrafter deps
      import einops, omegaconf, jaxtyping, peft, trimesh
      import cv2, skimage, sklearn, huggingface_hub
      print('✓ PartCrafter deps')

      # App modules
      from app.models.partcrafter import PartCrafterModel; print('✓ PartCrafterModel')
      from app.models.sdxl_turbo import SDXLTurboModel; print('✓ SDXLTurboModel (class only)')
      from app.services.pipeline import PipelineOrchestrator; print('✓ PipelineOrchestrator')

      print()
      print('All imports pass — safe to build + deploy.')
      "

  serve:
    description: Run server locally with hot reload
    cmd: uv run uvicorn app.main:create_app --factory --host 0.0.0.0 --port 8080 --reload

  build-base:
    description: Build and push the pre-built base image (run when deps change)
    cmd: |
      cd .. && gcloud builds submit \
        --config infrastructure/cloudbuild-base.yaml \
        --project=lumen-pipeline --region=us-east4 \
        server/

  build-local:
    description: Build Docker image locally (uses base image if available)
    cmd: docker build -t lumen-server .

  lock:
    description: Regenerate lock file after dependency changes
    cmd: uv lock

  build:
    description: Build and push Docker image via Cloud Build (with layer caching)
    cmd: |
      cd .. && gcloud builds submit \
        --config infrastructure/cloudbuild.yaml \
        --project=lumen-pipeline --region=us-east4 \
        .

  deploy:
    description: Deploy latest image to Cloud Run
    cmd: |
      gcloud run deploy lumen-pipeline \
        --image=us-east4-docker.pkg.dev/lumen-pipeline/lumen-pipeline-docker/lumen-pipeline:latest \
        --project=lumen-pipeline \
        --region=us-east4

  apply-terraform:
    description: Apply Terraform config (infra changes)
    cmd: cd ../infrastructure/terraform && terraform apply -auto-approve

  release:
    description: Full release — cloud build + deploy + health check
    cmd: |
      cd .. && gcloud builds submit \
        --config infrastructure/cloudbuild.yaml \
        --project=lumen-pipeline --region=us-east4 \
        . && \
      gcloud run deploy lumen-pipeline \
        --image=us-east4-docker.pkg.dev/lumen-pipeline/lumen-pipeline-docker/lumen-pipeline:latest \
        --project=lumen-pipeline \
        --region=us-east4 && \
      echo "✓ Deployed. Checking health..." && \
      SERVICE_URL=$(gcloud run services describe lumen-pipeline --project=lumen-pipeline --region=us-east4 --format='value(status.url)') && \
      curl -s "$SERVICE_URL/health" | python3 -m json.tool

  release-pipeline:
    description: Alias for release
    cmd: lets release

  deploy-frontend:
    description: Build frontend + deploy to GCS static hosting
    cmd: |
      cd .. && \
      VITE_LUMEN_SERVER_URL=$(gcloud run services describe lumen-pipeline \
        --project=lumen-pipeline --region=us-east4 \
        --format='value(status.url)') \
      npm run build && \
      BUCKET=$(cd infrastructure/terraform && terraform output -raw frontend_bucket_name) && \
      gcloud storage rsync dist/ "gs://$BUCKET" \
        --delete-unmatched-destination-objects \
        --cache-control="public, max-age=300" && \
      echo "✓ Frontend deployed to: https://storage.googleapis.com/$BUCKET/index.html"

  release-all:
    description: Full release — backend + frontend + health check
    cmd: |
      lets release && lets deploy-frontend
